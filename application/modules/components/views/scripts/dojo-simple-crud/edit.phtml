<?php 
$modAux = $this->mode != 'clone' ? $this->mode : 'add';
?>
<form dojoType="dijit.form.Form" target="ifrm_process" id="<?php echo $this->domPrefix?>form_<?php echo $modAux?>" class="tabForm" jsId="<?php echo $this->domPrefix?>form_<?php echo $modAux?>" name="<?php echo $this->domPrefix?>form_<?php echo $this->mode?>" encType="multipart/form-data"  action="<?php echo BASE_URL?>crud-request" method="post">
<?php 
$i = 0;
$tableWrapperClass = '';

if (!$this->loadPartial) :
    if (count($this->tabs) > 1) :
        $tableWrapperClass = "settingsArea";
        foreach ($this->tabs as $tab) :
            //if ($tab->getAttribute($this->mode) === 'true') :
            $style = $i == 0 ? 'style="background-image: url(/dojotoolkit/dijit/themes/claro/images/activeGradient.png); background-color: rgb(207, 229, 250); background-position: initial initial; background-repeat: repeat no-repeat;"' : '';
            $i++;
?>
    <a id="<?php echo $this->domPrefix ?>tab<?php echo $this->mode ?>_ctrl<?php echo $i?>" class="settingsTab" <?php echo $style ?> onclick="admportal.switchTabs('<?php echo $this->domPrefix?>form_<?php echo $modAux?>', this.id, '<?php echo $this->domPrefix.'Tab_'.$this->mode.$i?>')"><?php echo $tab->getAttribute('name') ?></a>
<?php 
            //endif;
        endforeach;
    endif;
?>
    <div class="brclear"></div>
<?php
    $i=0;
    $j=0;
    foreach ($this->tabs as $tab) :
        $style = $i == 0 ? 'style="display:block"' : 'style="display:none"'; 
        $i++;
?>
    <div id="<?php echo $this->domPrefix.'Tab_'.$this->mode.$i?>" class="settingsArea" <?php echo $style ?>>
        <table>
<?php 
        $k=0;
        foreach ($tab as $element) :
            $j++;
            $k++;
            $hidden = '';
            $params = (array) $element->attributes();
            $params = $params['@attributes'];
            if ($element->existsChildren('tinyMceInit')) {
                $params['tinyMceInit'] = dom_import_simplexml($element->tinyMceInit)->textContent;
            }
            
            if ($element->existsChildren('thumb')) {
                $params['thumbs'] = array();
                foreach ($this->xml->xpath("//elements/element[@target='{$params['target']}']/thumb") as $t) {
                    $params['thumbs'][] = $t;
                }
            }
            
            $params['domId'] = $this->domPrefix . "_{$this->mode}_";
            $params['mode'] = $this->mode;
            $params['i'] = $j;
            $hidden = $params['type'] == 'hidden' ? ' style="display:none"' : '';
            
            if (isset($_REQUEST[$params['target']])) $params['value'] = $_REQUEST[$params['target']]; //Esto aplica para formularios cargados vÃ­a ajax
            if (isset($this->data[$params['target']])) $params['value'] = $this->data[$params['target']];
            
            $params['target'] = "data[{$params['target']}]";
?>
            <tr<?php echo $hidden?>>
                <th><label for="<?php echo $element->getAttribute('target')?>"><?php echo $element->getAttribute('name') ?></label></th>
                <td><?php echo $this->action('index', $element->getAttribute('type'), 'elements', $params); ?></td>
            </tr>
<?php 
        endforeach;
?>
        </table>
    </div>
<?php
    endforeach;
endif;
?>
    <input type="hidden" name="format" value="json" />
    <input type="hidden" name="action" value="<?php echo $modAux ?>" />
    <input type="hidden" name="model" value="<?php echo $this->model?>" />
    <input type="hidden" name="p" value="<?php echo $this->p ?>" />
<?php 
if ($this->mode == 'edit' || $this->mode == 'clone') :
    foreach ($this->modelPrimary as $p) :
        $value = isset($_REQUEST['primary']) ? $_REQUEST['primary'][$p] : '';
?>
    <input type="hidden" name="primary[<?php echo $p?>]" value="<?php echo $value ?>" />
<?php 
    endforeach;
endif;
?>
    <script type="dojo/method" event="onSubmit">
    if (this.validate()) {
        try {
            var form = new zwei.Form({
                dijitForm: this, 
                dijitDialog: dijit.byId('<?php echo $this->domPrefix?>dialog_<?php echo $this->mode != 'clone' ? $this->mode : 'add'?>'),
                dijitDataGrid: dijit.byId('<?php echo $this->domPrefix?>dataGrid'),
                dijitFormSearch: dijit.byId('<?php echo $this->domPrefix?>formSearch'),
                iframe: dojo.byId('ifrm_process')
            });
            <?php echo $this->onSubmit ?>
            
            var observer = form.watch("response", function(name, oldValue, response) {
                console.debug(response);
                if (response != null) {
                    <?php echo $this->onPostSubmit ?>
                    if (response.todo == 'goToLogin') window.location.href = base_url + '/login';
                    else if (response.todo == 'cargarArbolMenu') admportal.loadMainMenu();
                    this.set("response", null);
                }
            });
            form.save();
            
        } catch (e) {
            console.debug(e);
            alert(e.message);
        }
        return false;
    } else {
        alert('Por favor corrija los campos marcados.');
        return false;
    }
    return true;
    </script>
    <button dojoType="dijit.form.Button" id="<?php echo $this->domPrefix?>tabs_btn_save<?php echo $this->mode != 'clone' ? $this->mode : 'add'?>" type="submit" />Guardar</button>
</form>